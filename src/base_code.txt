  import React, { useState, useEffect } from "react";
  import Globe from "react-globe.gl";


  function MyGlobe() {
    const [data, setData] = useState([]);
    const [sidebarOpen, setSidebarOpen] = useState(false);
    const [sidebarCountry, setSidebarCountry] = useState("");
    const [countryNews, setCountryNews] = useState([]);
    const [isLoadingNews, setIsLoadingNews] = useState(false);
    const colorMap = [
    "#FF6B6B", // soft coral red
    "#FFD93D", // warm golden yellow
    "#6BCB77", // fresh green
    "#4D96FF", // calm blue
    "#9D4EDD", // rich purple
    "#00B4D8", // cyan blue
    "#FFB5E8", // pastel pink
    "#C77DFF"  // lavender violet
  ];
    

    useEffect(() => {
      fetch("/countries.geojson")
        .then((res) => res.json())
        .then((geojson) => {
          if (!geojson.features) {
            console.error("Invalid GeoJSON structure");
            return;
          }
          // Assign colors only, no news
          const augmented = geojson.features.map((f, idx) => ({
            ...f,
            properties: {
              ...f.properties,
              color: colorMap[idx % colorMap.length],
            },
          }));
          setData(augmented);
        })
        .catch((e) => console.error("Fetch geojson error: ", e));
    }, []);

    const handlePolygonClick = (feature) => {
      const country = feature.properties.ADMIN || feature.properties.name || feature.properties.COUNTRY || "Unknown";
      
      setSidebarCountry(country);
      setSidebarOpen(true);
      setCountryNews([]); // 1. Clears old news immediately
      setIsLoadingNews(true); // 2. Uses a dedicated state for loading

      if (country === "Unknown") {
        setCountryNews([{ title: "Country name not found in data." }]);
        setIsLoadingNews(false);
        return;
      }
      const prompt = `What are the 4 latest news headlines about ${country} without summary?`;
      fetch(`http://127.0.0.1:5000/news?prompt=${encodeURIComponent(prompt)}`)
        .then(response => {
          if (!response.ok) {
            console.log("‚úÖ Connection established. Status:", response.status);
            throw new Error(`Network response was not ok (status: ${response.status})`);
          }
          return response.json();
        })
        .then(data => {
          console.log("news recieved",data)
          setCountryNews(data.headlines || []); // Correctly sets the array of objects
        })
        .catch(error => {
          console.error("Fetch error:", error);
          // Sets an error object for consistent rendering
          setCountryNews([{ title: "Error: Could not fetch news." }]);
        })
        .finally(() => {
          setIsLoadingNews(false); // 3. Hides loading indicator, regardless of success/failure
        });
    };

    if (data.length === 0) return <div>Loading country globe...</div>;

    return (
      <div style={{ width: "100vw", height: "100vh", position: "relative" }}>
        <Globe
          globeImageUrl="//unpkg.com/three-globe/example/img/earth-blue-marble.jpg"
          polygonsData={data}
          polygonCapColor={(feature) => feature.properties.color}
          polygonSideColor={() => "rgba(0,100,0,0.15)"}
          polygonStrokeColor={() => "#111"}
          polygonAltitude={0.01}
          polygonLabel={(feature) =>
            `<b>${feature.properties.ADMIN || feature.properties.name || feature.properties.COUNTRY || "Unknown"}</b><br/>Click for news`
          }
          onPolygonClick={handlePolygonClick}
          ambientLightColor="white"
          ambientLightIntensity={3}
          pointLightColor="white"
          pointLightIntensity={1.5}
        />
        {sidebarOpen && (
          <div style={{
            position: "absolute",
            top: 0,
            right: 0,
            width: "350px",
            height: "100vh",
            background: "#fff",
            boxShadow: "-2px 0 8px rgba(0,0,0,0.15)",
            zIndex: 10,
            overflowY: "auto",
            padding: "24px"
          }}>
            <button style={{ float: "right" }} onClick={() => setSidebarOpen(false)}>Close</button>
            <h2>{sidebarCountry} News</h2>
            {isLoadingNews ? (
              <p>Loading news...</p> // 1. Shows a loading message
            ) : (
              <ul>
                {countryNews.length > 0 ? (
                  countryNews.map((newsItem, idx) => (
                    <li key={idx} style={{ marginBottom: "16px", listStyle: "none" }}>
                      {newsItem.url ? (
                        <a href={newsItem.url} target="_blank" rel="noopener noreferrer" style={{ textDecoration: 'none', color: '#007BFF' }}>
                          <strong>{newsItem.title}</strong>
                        </a>
                      ) : (
                        <strong>{newsItem.title}</strong>
                      )}
                      {newsItem.description && <p style={{ margin: '4px 0 0', fontSize: '0.9em', color: '#555' }}>{newsItem.description}</p>}

                      {(newsItem.source || newsItem.author || newsItem.published) && (
                        <small style={{ color: '#888' }}>
                          {newsItem.source && `Source: ${newsItem.source} `}
                          {newsItem.author && `| Author: ${newsItem.author} `}
                          {newsItem.published && `| Published: ${newsItem.published}`}
                        </small>
                      )}
                    </li>
                  ))
                ) : (
                  <li>No news found.</li>
                )}
              </ul>

            )}
          </div>
        )}
      </div>
    );
  }

  export default MyGlobe;


fetchnews.py
import os
import json
import asyncio
from flask import Flask, jsonify, request
from dotenv import load_dotenv
import re

# LangChain and MCP imports
from langchain_core.messages import HumanMessage, ToolMessage
from langchain_groq import ChatGroq
from langchain_mcp_adapters.tools import load_mcp_tools
from langchain.agents import create_agent
from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client
from flask_cors import CORS

load_dotenv()
groq_api_key = os.getenv("GROQ_API_KEY")
if not groq_api_key:
    raise ValueError("GROQ_API_KEY not found in .env file. Please add it.")

model = ChatGroq(
    model="openai/gpt-oss-120b",
    temperature=0,
    api_key=groq_api_key,
)

# server_params = StdioServerParameters(
#     command="python",
#     args=["-m", "google_news_trends_mcp"],
# )

server_params = StdioServerParameters(
    command="docker",
    args=[
        "run",
        "--rm",
        "-i",
        "-e",
        f"NEWS_API_KEY={os.getenv('NEWS_API_KEY')}",
        "mcp/news-api",
    ],
)

# Flask app setup
app = Flask(__name__)
CORS(app, resources={r"/*": {"origins": "*"}}, supports_credentials=True)


async def run_agent(prompt_text: str):
    async with stdio_client(server_params) as (read, write):
        async with ClientSession(read, write) as session:
            await session.initialize()
            tools = await load_mcp_tools(session)
            print(f"‚úÖ Loaded {len(tools)} tools: {[tool.name for tool in tools]}")
            print("‚úÖ MCP connection initialized successfully.")
            agent_executor = create_agent(model=model, tools=tools)
            agent_input = {"messages": [HumanMessage(content=prompt_text)]}
            print("--------------model intialised-----------------")
            try:
                response = await agent_executor.ainvoke(agent_input)
                print("Received response")
            except Exception as e:
                print("Error during ainvoke:", repr(e))
                raise
            print("---------------------response received----------------------")
            tool_message_content = None
            if "messages" in response:
                for message in response["messages"]:
                    if isinstance(message, ToolMessage):
                        tool_message_content = message.content
                        print(tool_message_content)
                        break
            if tool_message_content:
                try:
                    return json.loads(tool_message_content)
                except:
                    return {"raw": tool_message_content}
            else:
                return []


def parse_headlines(raw_text):
    headlines = []
    articles = raw_text.split("---")

    for article in articles:
        if "Title:" not in article:
            continue

        title_match = re.search(r"Title:\s*(.+?)(?:\n|$)", article)
        url_match = re.search(r"URL:\s*(.+?)(?:\n|$)", article)
        source_match = re.search(r"Source:\s*(.+?)(?:\n|$)", article)
        author_match = re.search(r"Author:\s*(.+?)(?:\n|$)", article)
        published_match = re.search(r"Published:\s*(.+?)(?:\n|$)", article)
        desc_match = re.search(r"Description:\s*(.+?)(?:\n|$)", article)

        headline = {
            "title": title_match.group(1).strip() if title_match else "No title",
            "url": url_match.group(1).strip() if url_match else None,
            "source": source_match.group(1).strip() if source_match else None,
            "author": (
                author_match.group(1).strip()
                if author_match and author_match.group(1).strip() != "None"
                else None
            ),
            "published": published_match.group(1).strip() if published_match else None,
            "description": desc_match.group(1).strip() if desc_match else None,
        }
        headlines.append(headline)

    return headlines


@app.route("/news", methods=["GET"])
def get_news():
    prompt_text = request.args.get("prompt")
    # ‚ö° RETRIEVE CATEGORY PARAMETER
    category = request.args.get("category", "general")

    if not prompt_text:
        return jsonify({"error": "Missing 'prompt' query parameter"}), 400

    # 1. Extract Country Name from the generic prompt
    # Example: "What are the 4 latest news headlines about Russia without summary?"
    match = re.search(r"about\s+(.+?)\s+without", prompt_text)
    country_name = match.group(1).strip() if match else "the world"

    # 2. ‚ö° CONSTRUCT THE FILTERED PROMPT for the agent
    final_prompt = f"What are the 4 latest {category} news headlines about {country_name} without summary?"

    print(f"üì® Received prompt: {prompt_text}")
    print(f"‚úÖ Filtering by Category: {category}")
    print("‚è≥ Processing prompt...")

    # 3. Use the filtered prompt
    raw_data = asyncio.run(run_agent(final_prompt))

    print("----------------------------print data------------------")
    print(raw_data)

    if isinstance(raw_data, dict) and "raw" in raw_data:
        headlines = parse_headlines(raw_data["raw"])
    else:
        headlines = []

    return jsonify({"headlines": headlines})


if __name__ == "__main__":
    app.run(debug=True)
